/*!
 * evol.advancedSearch 1.0
 *
 * Copyright (c) 2013, Olivier Giulieri 
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *	jquery.ui.button.js
 *	jquery.ui.datepicker.js
 */

(function(e,t){var n={sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewFilter:"New filter",bAddFilter:"Add filter",bUpdateFilter:"Update filter",bCancel:"Cancel"},r={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"},i={text:"text",bool:"boolean",number:"number",date:"date",time:"time",lov:"lov"};e.widget("evol.advancedSearch",{version:"1.0",options:{fields:[],dateFormat:"mm/dd/yy",highlight:true,buttonLabels:false,submitReady:false},_create:function(){var t=this.options.buttonLabels,s=this,o=this.element;this._step=0;o.addClass("evo-advSearch ui-widget-content ui-corner-all").html(['<div class="evo-searchFilters"></div>','<a class="evo-bNew" href="javascript:void(0)">',n.bNewFilter,"</a>",'<span class="evo-editFilter"></span>','<a class="evo-bAdd" style="display:none;" href="javascript:void(0)">',n.bAddFilter,"</a>",'<a class="evo-bDel" style="display:none;" href="javascript:void(0)">',n.bCancel,"</a>"].join(""));if(this.options.submitReady){this._hValues=e("<span></span>").appendTo(o)}this._bNew=o.find(".evo-bNew").button({text:t,icons:{secondary:"ui-icon-plusthick"}}).on("click",function(e){if(s._step<1){s._setEditorField();s._step=1}s._bAdd.find(".ui-button-text").html(n.bAddFilter)});this._bAdd=o.find(".evo-bAdd").button({text:t,icons:{secondary:"ui-icon-check"}}).on("click",function(e){var t=s._getEditorData();if(s._cFilter){s._enableFilter(t,s.options.highlight)}else{s.addFilter(t)}s._removeEditor()});this._bDel=o.find(".evo-bDel").button({text:t,icons:{secondary:"ui-icon-close"}}).on("click",function(e){s._removeEditor()});this._editor=o.find(".evo-editFilter").on("change","#field",function(t){t.stopPropagation();if(s._step>2){s._editor.find("#value,#value2,.as-Txt").remove()}if(s._step>1){s._editor.find("#operator").remove();s._bAdd.hide()}s._step=1;var n=e(t.currentTarget).val();if(n!=""){s._field=s._getFieldById(n);var r=s._type=s._field.type;s._setEditorOperator();if(r==i.lov||r==i.bool){s._setEditorValue()}}else{s._field=s._type=null}}).on("change","#operator",function(t){t.stopPropagation();s._operator=e(this).val();if(s._step>2){s._editor.find("#value,#value2,.as-Txt").remove();s._bAdd.hide();s._step=2}s._setEditorValue()}).on("change keyup","#value,#value2",function(t){t.stopPropagation();var n=s._type,o=e(this).val(),u=o!=""||n==i.lov||n==i.bool;if(n==i.number){u=u&&!isNaN(o)}else if(s._operator==r.sBetween){u=s._editor.find("#value").val()!=""&&s._editor.find("#value2").val()!=""}if(u){s._bAdd.button("enable");if(t.which==13){s._bAdd.trigger("click")}}else{s._bAdd.button("disable")}}).on("click","#checkAll",function(){var t=e(this),n=t.attr("checked"),r=t.siblings();if(n=="checked"){r.attr("checked",n)}else{r.removeAttr("checked")}});this._filters=o.find(".evo-searchFilters").on("click","a",function(){s._editFilter(e(this))}).on("click","a .ui-button-icon-secondary",function(t){t.stopPropagation();var n=e(this).parent();if(!n.hasClass("ui-state-disabled")){n.fadeOut("slow",function(){n.remove();s._triggerChange()})}})},_getFieldById:function(e){if(!this._hash){this._hash={};var t=this.options.fields;for(var n=0,r=t.length;n<r;n++){this._hash[t[n].id]=t[n]}}return this._hash[e]},_removeEditor:function(){this._editor.empty();this._bAdd.hide();this._bDel.hide();this._enableFilter(null,false);this._bNew.removeClass("ui-state-active").show().focus();this._step=0;this._field=this._type=this._operator=null},addFilter:function(t){var n=e(['<a href="javascript:void(0)">',this._htmlFilter(t),"</a>"].join("")).prependTo(this._filters).button({icons:{secondary:"ui-icon-close"}}).data("filter",t).fadeIn();if(this.options.highlight){n.effect("highlight")}this._triggerChange();return this},removeFilter:function(e){this._filters.children().eq(e).remove();this._triggerChange();return this},_htmlFilter:function(e){var t=['<span class="evo-lBold">',e.field.label,"</span> ",'<span class="evo-lLight">',e.operator.label,"</span> ",'<span class="evo-lBold">',e.value.label,"</span>"];if(e.operator.value==r.sBetween){t.push('<span class="evo-lLight"> ',n.opAnd," </span>",'<span class="evo-lBold">',e.value.label2,"</span>")}return t.join("")},_enableFilter:function(e,t){if(this._cFilter){this._cFilter.button("enable").removeClass("ui-state-hover ui-state-active");if(t){this._cFilter.effect("highlight")}if(e){this._cFilter.data("filter",e).find(":first-child").html(this._htmlFilter(e));this._cFilter=null;this._triggerChange()}else{this._cFilter=null}}},_editFilter:function(e){var t=e.data("filter"),i=t.field.value,s=t.operator.value,o=t.value;this._enableFilter(null,false);this._removeEditor();this._cFilter=e.button("disable");var u=this._getFieldById(i).type;this._setEditorField(i);this._setEditorOperator(s);if(s==r.sBetween){this._setEditorValue(o.value,o.value2)}else{this._setEditorValue(o.value)}this._bAdd.find(".ui-button-text").html(n.bUpdateFilter);this._step=3},_setEditorField:function(t){if(this._step<1){this._bNew.stop().hide();this._bDel.show();if(!this._fList){var n=this.options.fields,r=['<select id="field"><option value=""></option>'];for(var i=0,o=n.length;i<o;i++){var u=n[i];r.push(s.inputOption(u.id,u.label))}r.push("</select>");this._fList=r.join("")}e(this._fList).appendTo(this._editor).focus()}if(t){this._field=this._getFieldById(t);this._type=this._field.type;this._editor.find("#field").val(t)}this._step=1},_setEditorOperator:function(e){var t=this._type;if(this._step<2){var o=[];switch(t){case i.lov:o.push(s.inputHidden("operator",r.sInList));this._operator=r.sInList;break;case i.bool:o.push(s.inputHidden("operator",r.sEqual));this._operator=r.sEqual;break;default:o.push('<select id="operator"><option value=""></option>');switch(t){case i.date:case i.time:if(t==i.time){o.push(s.inputOption(r.sEqual,n.sAt),s.inputOption(r.sNotEqual,n.sNotAt))}else{o.push(s.inputOption(r.sEqual,n.sOn),s.inputOption(r.sNotEqual,n.sNotOn))}o.push(s.inputOption(r.sGreater,n.sAfter),s.inputOption(r.sSmaller,n.sBefore),s.inputOption(r.sBetween,n.sBetween));break;case i.number:o.push(s.inputOption(r.sEqual,n.sNumEqual),s.inputOption(r.sNotEqual,n.sNumNotEqual),s.inputOption(r.sGreater,n.sGreater),s.inputOption(r.sSmaller,n.sSmaller));break;default:o.push(s.inputOption(r.sEqual,n.sEqual),s.inputOption(r.sNotEqual,n.sNotEqual),s.inputOption(r.sStart,n.sStart),s.inputOption(r.sContain,n.sContain),s.inputOption(r.sFinish,n.sFinish))}o.push(s.inputOption(r.sIsNull,n.sIsNull),s.inputOption(r.sIsNotNull,n.sIsNotNull));o.push("</select>")}this._editor.append(o.join(""))}if(e&&t!=i.lov){this._editor.find("#operator").val(e);this._operator=e}this._step=2},_setEditorValue:function(e,t){var o=this._editor,u=this._type,a=o.find("#operator").val(),f=true;if(a!=""){if(u!=i.lov&&(a==r.sIsNull||a==r.sIsNotNull)){o.append(s.inputHidden("value",""))}else{if(this._step<3){var l=[],c=a==r.sBetween;switch(u){case i.lov:l.push('<span id="value">');if(this._field.list.length>7){l.push('(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) ')}l.push(s.inputCheckboxLOV(this._field.list));l.push("</span>");break;case i.bool:l.push('<span id="value">',s.inputRadio("value","1",n.yes,e!="0","value1"),s.inputRadio("value","0",n.no,e=="0","value0"),"</span>");break;case i.date:case i.time:case i.number:var h=u==i.date?"text":u;l.push('<input id="value" type="',h,'"/>');if(c){l.push('<span class="as-Txt">',n.opAnd," </span>",'<input id="value2" type="',h,'"/>')}f=false;break;default:l.push('<input id="value" type="text"/>');f=false}o.append(l.join(""));if(u==i.date){o.find("#value,#value2").datepicker({dateFormat:this.options.dateFormat})}}if(e){var p=o.find("#value");switch(u){case i.lov:p.find("#"+e.split(",").join(",#")).attr("checked","checked");break;case i.bool:p.find("#value"+e).attr("checked","checked");break;default:p.val(e);f=e!="";if(c){p.next().next().val(t);f=e!=""&&t!=""}}}else{f=u==i.lov||u==i.bool}}this._bAdd.button(f?"enable":"disable").show();this._step=3}},_getEditorData:function(){var e=this._editor,t=e.find("#field"),s=e.find("#value"),o={field:{label:t.find("option:selected").text(),value:t.val()},operator:{},value:{}},u=o.operator,a=o.value;if(this._type==i.lov){var f=[],l=[];s.find("input:checked").not("#checkAll").each(function(){f.push(this.value);l.push(this.nextSibling.innerHTML)});if(f.length==0){u.label=n.sIsNull;u.value=r.sIsNull;a.label=a.value=""}else if(f.length==1){u.label=n.sEqual;u.value=r.sEqual;a.label='"'+l[0]+'"';a.value=f[0]}else{u.label=n.sInList;u.value=r.sInList;a.label="("+l.join(", ")+")";a.value=f.join(",")}}else if(this._type==i.bool){u.label=n.sEqual;u.value=r.sEqual;var c=s.find("#value1").attr("checked")=="checked"?1:0;a.label=c==1?n.yes:n.no;a.value=c}else{var h=e.find("#operator"),p=h.val();u.label=h.find("option:selected").text();u.value=p;if(p==r.sIsNull||p==r.sIsNotNull){a.label=a.value=""}else{if(this._type==i.number||this._type==i.date||this._type==i.time){a.label=s.val()}else{a.label='"'+s.val()+'"'}a.value=s.val();if(p==r.sBetween){a.label2=a.value2=s.next().next().val()}}}return o},_hiddenValue:function(e,t,n){e.push(s.inputHidden("fld-"+n,t.field.value),s.inputHidden("op-"+n,t.operator.value),s.inputHidden("val-"+n,t.value.value));var r=t.value.value2;if(r){e.push(s.inputHidden("val2-"+n,r))}},_setHiddenValues:function(){var e=this.val(),t=e.length,n=[s.inputHidden("elem",t)];for(var r=0;r<t;r++){this._hiddenValue(n,e[r],r+1)}this._hValues.html(n.join(""))},_triggerChange:function(){if(this.options.submitReady){this._setHiddenValues()}this.element.trigger("change.search")},val:function(t){if(typeof t=="undefined"){var n=[];this._filters.find("a").each(function(){n.push(e(this).data("filter"))});return n}else{this._filters.empty();for(var r=0,i=t.length;r<i;r++){this.addFilter(t[r])}this._triggerChange();return this}},valText:function(){var e=[];this._filters.find("a").each(function(){e.push(this.text)});return e.join(" "+n.opAnd+" ")},valUrl:function(){var e=this.val(),t=e.length,n=["filters=",t];if(t<1)return"";for(var i=0;i<t;i++){var s=e[i];n.push("&field-",i,"=",s.field.value,"&operator-",i,"=",s.operator.value,"&value-",i,"=",encodeURIComponent(s.value.value));if(s.operator==r.sBetween){n.push("&value2-",i,"=",encodeURIComponent(s.value.value2))}}n.push("&label=",encodeURIComponent(this.valText()));return n.join("")},empty:function(){this._cFilter=null;this._removeEditor();this._filters.empty();this._triggerChange();return this},length:function(){return this._filters.children().length},destroy:function(){var t=this.element.off();t.find(".evo-bNew,.evo-bAdd,.evo-bDel,.evo-searchFilters").off();this._editor.off();t.empty().removeClass("evo-advSearch ui-widget-content ui-corner-all");e.Widget.prototype.destroy.call(this)}});var s={inputRadio:function(e,t,n,r,i){var s=['<label for="',i,'"><input id="',i,'" name="',e,'" type="radio" value="',t];if(r){s.push('" checked="checked')}s.push('">',n,"</label> ");return s.join("")},inputHidden:function(e,t){return['<input type="hidden" name="',e,'" value="',t,'"/>'].join("")},inputOption:function(e,t){return['<option value="',e,'">',t,"</option>"].join("")},inputCheckboxLOV:function(e){var t=[];for(var n in e){var r=e[n];t.push('<input type="checkbox" id="',r.id,'" value="',r.id,'"/>','<label for="',r.id,'">',r.label,"</label> ")}return t.join("")}}})(jQuery)